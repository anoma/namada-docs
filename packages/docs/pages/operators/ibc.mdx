import { Callout } from 'nextra-theme-docs'
import Expandable from '../../components/Expandable'

# Relaying on Namada

This document describes how to operate a relayer for the Inter-Blockchain Communication (IBC) protocol with Namada. This documentation covers being able to create connections through IBC as well as setting up local instances of Namada for testing purposes.


This document covers essential steps for using IBC with Namada:

1. [Setup Hermes](#setup-hermes)
2. [Install Hermes](#install-hermes)
3. [Setting up the relayer](#setting-up-the-relayer)
4. [Start the relayer](#start-the-relayer)
5. [Set up local Namada instances](#set-up-local-namada-instances-using-the-hermes-script)

The below is intended for those that wish to relay IBC message transfers between two Namada chains. There is of course the capability to do this between any two IBC compatible chains (such as a Cosmos chain).
In this case, it is necessary to have a node running on both the destination and the source chain in order to make any package transfers.
Below, we discuss first how to enable this connection between two pre-existing chains by Hermes, and second, setting up two Namada local instances or joining two pre-existing Namada instances for this purpose.


## Setup Hermes
Hermes is an IBC relayer to relay IBC packets between chains (instances).
We have our [fork of Hermes supporting Namada instances](https://github.com/heliaxdev/hermes/tree/1.6.0-namada).
Before packet relay, we need the following steps to configure and start Hermes.

1. Make Hermes config file
2. Create IBC client/connection/channel between instances
3. Run Hermes

### Make Hermes config file
One essential piece of the puzzle is to create a `config.toml` file that describes what connections will be set up that the relayer will be responsible for.

```bash copy
export HERMES_CONFIG="<choose path for hermes config>/config.toml"
touch $HERMES_CONFIG
``` 

If you don't specify the file path, `~/.hermes/config.toml` is read as default.

You can find an example of the config file below. Essentially, you change only the chain IDs, the RPC addresses, and the key names in the config file for Namada. If you don't have nodes, please set up nodes manually or through our [scripts](#set-up-local-namada-instances-using-the-hermes-script).

<details>
<summary>Example: config.toml</summary>
```toml copy
[global]
log_level = 'info'

[mode]

[mode.clients]
enabled = true
refresh = true
misbehaviour = true

[mode.connections]
enabled = false

[mode.channels]
enabled = false

[mode.packets]
enabled = true
clear_interval = 10
clear_on_start = false
tx_confirmation = true

[telemetry]
enabled = false
host = '127.0.0.1'
port = 3001

[[chains]]
id = 'namada-test.0a4c6786dbda39f786'  # set your chain ID
type = 'namada'
rpc_addr = 'http://127.0.0.1:27657'  # set the IP and the port of the chain
grpc_addr = 'http://127.0.0.1:9090'  # not used for now
event_source = { mode = 'push', url = 'ws://127.0.0.1:27657/websocket', batch_delay = '500ms' }  # set the IP and the port of the chain
account_prefix = ''  # not used
key_name = 'relayer'  # The key is an account name you made
store_prefix = 'ibc'
gas_price = { price = 0.001, denom = 'nam' }  # not used for now

[[chains]]
id = 'namada-test.647287156defa8728c'
type = 'namada'
rpc_addr = 'http://127.0.0.1:28657'
grpc_addr = 'http://127.0.0.1:9090'
event_source = { mode = 'push', url = 'ws://127.0.0.1:28657/websocket', batch_delay = '500ms' }
account_prefix = ''
key_name = 'relayer'
store_prefix = 'ibc'
gas_price = { price = 0.001, denom = 'nam' }
```
</details>

The path to the config file, which is saved in the variable `$HERMES_CONFIG` will be useful later.


<Callout type="info" emoji="ðŸ§©">
**Interpreting the toml**

Each chain configuration is specified under the `[[chains]]` object.
These are the pieces of this puzzle you want to keep your ðŸ‘€ on:
 - `chains.id` is the name of the chain
 - `chains.rpc_address` specifies the port that the channel is communicating through, and will be the argument for the `ledger_address` of Namada when interacting with the ledger (will become clearer later)
     - Make sure to change the IP address to the IP address of your local machine that is running this node!
 - `chains.key_name` specifies the key of the signer who signs a transaction from the relayer. The key should be generated before starting the relayer.
 - `event_source` specifies the URL of the chain's websocket. This must be the same as the `rpc_address` for Hermes to work properly.
</Callout>

### Create IBC client/connection/channel between instances
Hermes CLI has commands to create them. Before the creation, a node of each instance should be running at the specified rpc addresses. If you don't have nodes, please set up nodes manually or through our [scripts](#set-up-local-namada-instances-using-the-hermes-script).

### Export environment variables
We will need to save certain environment variables. These are:
```bash copy
export CHAIN_A_ID="<replace-with-chain-a-id>"
export CHAIN_B_ID="<replace-with-chain-b-id>"
export HERMES_CONFIG="<replace-with-hermes-config-path>"
```

## Install Hermes
Before conducting any IBC operations, one must download Heliax's fork Hermes binary or build it from source.

### From binaries
One can download the latest binary release from our [releases page](https://github.com/heliaxdev/hermes/releases) by choosing the appropriate architecture.

E.g.
```bash copy
export TAG="v1.6.0-namada-beta3"
export ARCH="x86_64-unknown-linux-gnu" # or "aarch64-apple-darwin"
curl -Lo /tmp/hermes.tar.gz https://github.com/heliaxdev/hermes/releases/download/${TAG}/hermes-${TAG}-${ARCH}.tar.gz
sudo tar -xvzf /tmp/hermes.tar.gz -C /usr/local/bin
```

### From source
```bash copy
export TAG="v1.6.0-namada-beta3"

git clone https://github.com/heliaxdev/hermes.git
git checkout $TAG
cd hermes
cargo build --release --bin hermes
export HERMES=$(pwd) # if needed
```
Check the binary:
```bash copy
./target/release/hermes --version
```

<Callout type="info">
It is recommended to now add hermes to `$PATH` such that it is callable without any pre-fixes.
For ubuntu users, this can be achieved by
```bash copy
sudo cp ./target/release/hermes /usr/local/bin/
```
</Callout>

## Setting up the relayer

### Create the `namada_wallet` directory and chain directories to hold each relayer wallet.toml

For the relayer to work, it needs to have a wallet directory to store the keys of the relayer. This can be done by running
```bash copy
# in the Hermes folder
mkdir -p ~/.hermes/namada_wallet/$CHAIN_A_ID
mkdir -p ~/.hermes/namada_wallet/$CHAIN_B_ID
```

### Create the relayer account
On each chain, there must be a `relayer` account. On a namada chain, this can be done by running
```bash copy
namadaw key gen --alias relayer
```

This will generate a key for the relayer account. The key will be stored in the `wallet.toml` that is found in the [base directory](./ledger/base-directory.mdx) of the node, inside the `chain-id` folder. For example, if the `chain-id` is `namada-test.0a4c6786dbda39f786`, the `wallet.toml` will be found in `$HOME/.local/share/namada/namada-test.0a4c6786dbda39f786/wallet.toml` (on a ubuntu machine where `base-dir` has not been set up properly).

It is now important to copy this wallet file into the `namada_wallet` directory that was created above, for each chain. Continuing this example, the first wallet can be copied by running:
```bash copy
cp $HOME/.local/share/namada/$CHAIN_A_ID/wallet.toml $HERMES/namada_wallet/$CHAIN_A_ID/wallet.toml
# Make sure this is done for both wallets on each chain!
```

We are now ready to set up the client.

### Create IBC channel
The "create channel" command (below) creates not only the IBC channel but also the necessary IBC client connection.

```bash copy
hermes --config $HERMES_CONFIG \
  create channel \
  --a-chain $CHAIN_A_ID \
  --b-chain $CHAIN_B_ID \
  --a-port transfer \
  --b-port transfer \
  --new-client-connection --yes
```

<Callout type="info">
Note that the above `CHAIN_IDs` will depend on your own setup, so do check this for yourself!
</Callout>

When the creation has been completed, you can see the channel IDs. For example, the following text shows that a channel with ID `7` has been created on Chain A `namada-test.0a4c6786dbda39f786`, and a channel with ID `12` has been created on Chain B `namada-test.647287156defa8728c`. You will need the channel IDs for a transfer over IBC. It means that you have to specify `channel-7` as a channel ID (The prefix `channel-` is always required) for a transfer from Chain A to Chain B. Also, you have to specify `channel-12` as a channel ID for a transfer from Chain B to Chain A.

<Expandable>
```
SUCCESS Channel {
    ordering: Unordered,
    a_side: ChannelSide {
        chain: BaseChainHandle {
            chain_id: ChainId {
                id: "namada-test.0a4c6786dbda39f786",
                version: 0,
            },
            runtime_sender: Sender { .. },
        },
        client_id: ClientId(
            "07-tendermint-0",
        ),
        connection_id: ConnectionId(
            "connection-3",
        ),
        port_id: PortId(
            "transfer",
        ),
        channel_id: Some(
            ChannelId(
                "channel-7",
            ),
        ),
        version: None,
    },
    b_side: ChannelSide {
        chain: BaseChainHandle {
            chain_id: ChainId {
                id: "namada-test.647287156defa8728c",
                version: 0,
            },
            runtime_sender: Sender { .. },
        },
        client_id: ClientId(
            "07-tendermint-1",
        ),
        connection_id: ConnectionId(
            "connection-2",
        ),
        port_id: PortId(
            "transfer",
        ),
        channel_id: Some(
            ChannelId(
                "channel-12",
            ),
        ),
        version: None,
    },
    connection_delay: 0ns,
}
```
</Expandable>

## Start the relayer
Once you run Hermes, it monitors instances via the nodes and relays packets according to monitored events.
```bash copy
hermes --config $HERMES_CONFIG start
```

You can see more details of Hermes at [the official document](https://hermes.informal.systems/).

After the sync, you can create the channel and start Hermes as we explain [above](#create-ibc-channel).
```bash copy
# create a channel
hermes --config $HERMES_CONFIG \
  create channel \
  --a-chain $CHAIN_A_ID \
  --b-chain $CHAIN_B_ID \
  --a-port transfer \
  --b-port transfer \
  --new-client-connection --yes
```

### Transferring assets over IBC
It is now possible to [transfer assets between the two chains.](../users/ibc.mdx)

## Set up local Namada instances using the hermes script
The script `setup-namada` will set up two instances with one validator node, copy necessary files for Hermes, and make an account for Hermes on each ledger. Also, it will make a Hermes' config file `config_for_namada.toml` in the `hermes` directory.
```bash copy
git clone https://github.com/heliaxdev/hermes.git
git checkout $TAG # The branch is the same as our Hermes
cd hermes
./scripts/setup-namada $NAMADA_DIR $CHAIN_ID_A $CHAIN_ID_B
```

In this case, we don't have to wait for sync. If the relayer account on each instance has enough balance, you can create a channel and start Hermes immediately as we explain [above](#create-ibc-channel). You find these chain IDs of the instances in the config file `config_for_namada.toml`. One can run `grep "id" ${HERMES_CONFIG}`.
```bash copy
# create a channel
hermes --config $HERMES_CONFIG \
  create channel \
  --a-chain $CHAIN_A_ID \
  --b-chain $CHAIN_B_ID \
  --a-port transfer \
  --b-port transfer \
  --new-client-connection --yes

# Run Hermes
hermes --config $HERMES_CONFIG start
```

Each node data and configuration files are in `hermes/data/namada-*/.namada`.

In order to close any ledgers setup by the script, one can run
```bash copy
killall namadan
```
